# ========================================
# Next.js Frontend .htaccess Configuration
# ========================================

# Enable Rewrite Engine
RewriteEngine On

# ========================================
# SECURITY HEADERS
# ========================================

# Security Headers
<IfModule mod_headers.c>
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options nosniff

    # Prevent clickjacking
    Header always set X-Frame-Options DENY

    # Enable XSS protection
    Header always set X-XSS-Protection "1; mode=block"

    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Content Security Policy
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://www.google-analytics.com https://cwbearing.de https://cwbackend.com; frame-src 'none'; object-src 'none';"

    # Remove server signature
    Header unset Server
    Header unset X-Powered-By
</IfModule>

# ========================================
# PERFORMANCE OPTIMIZATION
# ========================================

# Enable Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>

# Browser Caching
<IfModule mod_expires.c>
    ExpiresActive On

    # Images
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"

    # Fonts
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"

    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"

    # HTML
    ExpiresByType text/html "access plus 1 hour"

    # Data
    ExpiresByType application/json "access plus 1 day"
    ExpiresByType application/xml "access plus 1 day"
    ExpiresByType text/xml "access plus 1 day"
</IfModule>

# ========================================
# INTERNATIONALIZATION ROUTING
# ========================================

# Handle locale-based routing for Next.js
# This ensures proper routing for multilingual content

# German (default) - cwbearing.de
RewriteCond %{HTTP_HOST} ^(www\.)?cwbearing\.de$ [NC]
RewriteCond %{REQUEST_URI} !^/de/
RewriteCond %{REQUEST_URI} !^/_next/
RewriteCond %{REQUEST_URI} !^/api/
RewriteCond %{REQUEST_URI} !^/static/
RewriteCond %{REQUEST_URI} !^/favicon\.ico
RewriteCond %{REQUEST_URI} !^/robots\.txt
RewriteCond %{REQUEST_URI} !^/sitemap\.xml
RewriteRule ^(.*)$ /de/$1 [L,R=301]

# English - www.cwbearing.com
RewriteCond %{HTTP_HOST} ^(www\.)?cwbearing\.com$ [NC]
RewriteCond %{REQUEST_URI} !^/en/
RewriteCond %{REQUEST_URI} !^/_next/
RewriteCond %{REQUEST_URI} !^/api/
RewriteCond %{REQUEST_URI} !^/static/
RewriteCond %{REQUEST_URI} !^/favicon\.ico
RewriteCond %{REQUEST_URI} !^/robots\.txt
RewriteCond %{REQUEST_URI} !^/sitemap\.xml
RewriteRule ^(.*)$ /en/$1 [L,R=301]

# ========================================
# NEXT.JS SPECIFIC RULES
# ========================================

# Handle Next.js static files
RewriteCond %{REQUEST_URI} ^/_next/static/.*
RewriteRule ^_next/static/(.*)$ /_next/static/$1 [L]

# Handle Next.js API routes
RewriteCond %{REQUEST_URI} ^/api/.*
RewriteRule ^api/(.*)$ /api/$1 [L]

# Handle Next.js image optimization
RewriteCond %{REQUEST_URI} ^/_next/image/.*
RewriteRule ^_next/image/(.*)$ /_next/image/$1 [L]

# ========================================
# CUSTOM ROUTES
# ========================================

# Handle draft mode URLs
RewriteCond %{QUERY_STRING} draft=true
RewriteRule ^(.*)$ /$1 [L]

# Handle sitemap
RewriteRule ^sitemap\.xml$ /api/sitemap [L]

# Handle robots.txt
RewriteRule ^robots\.txt$ /api/robots [L]

# ========================================
# ERROR PAGES
# ========================================

# Custom error pages
ErrorDocument 404 /404
ErrorDocument 500 /500

# ========================================
# REDIRECTS
# ========================================

# Remove trailing slashes (except for root)
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} (.+)/$
RewriteRule ^ %1 [R=301,L]

# Force HTTPS (uncomment if using SSL)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# ========================================
# BASIC AUTHENTICATION
# ========================================

# Enable authentication for the entire site
AuthType Basic
AuthName "Restricted Area"
AuthUserFile .htpasswd
Require valid-user

# ========================================
# BLOCK UNWANTED ACCESS
# ========================================

# Block access to sensitive files
<FilesMatch "\.(env|git|htaccess|htpasswd|ini|log|sh|sql|conf)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Block access to node_modules
RewriteRule ^node_modules/ - [F,L]

# Block access to .git directory
RewriteRule ^\.git/ - [F,L]

# ========================================
# CORS HEADERS (if needed for API)
# ========================================

<IfModule mod_headers.c>
    # Allow CORS for API routes
    <LocationMatch "^/api/">
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
    </LocationMatch>
</IfModule>

# ========================================
# MAINTENANCE MODE (uncomment when needed)
# ========================================

# RewriteCond %{REMOTE_ADDR} !^YOUR_IP_ADDRESS$
# RewriteRule ^(.*)$ /maintenance.html [R=302,L]
